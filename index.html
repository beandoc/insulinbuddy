<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>InsulinBuddy - Learning & Tracking</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html,body { min-height: 100%; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            transition: background 0.3s, color 0.3s;
        }
        .dark {
            background-color: #1e293b !important;
            color: #f1f5f9 !important;
        }
        .dark .bg-white { background-color: #334155 !important; }
        .dark .text-slate-700, .dark .text-slate-600 { color: #cbd5e1 !important; }
        .dark .border-slate-200, .dark .border-slate-100 { border-color: #334155 !important; }
        .dark .shadow-lg, .dark .shadow-xl { box-shadow: 0 2px 8px rgba(0,0,0,0.7); }
        .dark .alert-warning { background-color: #fbbf24; color: #78350f; }
        .dark .alert-danger { background-color: #ef4444; color: #fff; }
        .dark .alert-info { background-color: #818cf8; color: #fff; }

        .page-content { padding-bottom: 80px; transition: opacity 0.2s; }
        .page-content.loading { opacity: 0.4; pointer-events: none; }

        /* Responsive chart height */
        @media (max-width: 500px) { .h-64 { height: 250px; } }

        .tab-indicator { transition: all 0.3s ease; }
        .time-in-range-chart { width: 100%; height: 12px; border-radius: 6px; overflow: hidden; display: flex; }
        .settings-option:hover { background-color: #e0f2fe; }
        .reward-card:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1); }
        .slider { -webkit-appearance: none; width: 100%; height: 10px; border-radius: 5px; background: #d1d5db; outline: none; transition: background 0.2s; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; border-radius: 50%; background: #4f46e5; cursor: pointer; box-shadow: 0 0 2px #222; }
        .slider::-moz-range-thumb { width: 24px; height: 24px; border-radius: 50%; background: #4f46e5; cursor: pointer; }
        .time-slot { transition: all 0.2s ease; border: 1px solid #cbd5e1; }
        .time-slot.selected { background-color: #4f46e5; color: white; border-color: #3730a3; font-weight: 600; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5); }
        .time-slot-hypo.selected { background-color: #dc2626; color: white; border-color: #b91c1c; box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.5); }
        .alert-message { padding: 0.75rem 1rem; margin-bottom: 1rem; border-left-width: 4px; border-radius: 0.375rem; font-size: 0.875rem; }
        .alert-warning { border-color: #f59e0b; background-color: #fffbeb; color: #b45309; }
        .alert-danger { border-color: #ef4444; background-color: #fef2f2; color: #b91c1c; }
        .alert-info { border-color: #4f46e5; background-color: #eef2ff; color: #3730a3; }
        .pro-tip { background-color: #fffbeb; border-left-width: 4px; border-color: #f59e0b; padding: 0.75rem; border-radius: 0.375rem; margin-top: 1rem; font-size: 0.875rem; color: #b45309; }
        .pro-tip h4 { font-weight: 600; display: flex; align-items: center; margin-bottom: 0.25rem; }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); } }
        .learning-modal { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .module-step { display: none; }
        .module-step.active { display: block; animation: fadeInStep 0.4s ease-out; }
        @keyframes fadeInStep { from { opacity: 0.5; } to { opacity: 1; } }
        .module-progress-bar { height: 8px; background-color: #4f46e5; border-radius: 4px; transition: width 0.3s ease-in-out; }
        .insulin-option input:checked + label { background-color: #eef2ff; border-color: #a5b4fc; }
        .page-header-colored { background: linear-gradient(to right, #4f46e5, #3730a3); color: white; padding: 1rem 1.25rem; border-radius: 0 0 1.5rem 1.5rem; margin: -1.25rem -1.25rem 1.5rem -1.25rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .injection-site { cursor: pointer; fill: #c7d2fe; stroke: #4f46e5; stroke-width:1.5; transition: fill 0.2s, transform 0.1s; }
        .injection-site:hover { fill: #818cf8; transform: scale(1.1); }
        .injection-site.active, .injection-site.completed { fill: #10b981; stroke: #059669; }
        .injection-site.error { fill: #ef4444; }
        .injection-site-number { fill: white; font-size: 10px; font-weight: bold; pointer-events: none; text-anchor: middle; dominant-baseline: middle; }
        .site-rotation-button-ui.completed { background-color: #10b981; color:white; border-color: #059669;}
        .nav-feature-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        input[type="text"]:focus, input[type="number"]:focus, input[type="datetime-local"]:focus, select:focus {
            outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5); border-color: #4f46e5;
        }
        button:focus-visible, .time-slot:focus-visible, .nav-feature-btn:focus-visible, .settings-option:focus-visible {
            outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
        }
        .reward-card[data-unlocked="true"] {
            border-color: #f59e0b;
            background-color: #fffbeb;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
        }
        .reward-card[data-unlocked="true"] img {
            filter: drop-shadow(0 0 5px rgba(245, 158, 11, 0.7));
        }
        /* Improved validation */
        input:invalid, select:invalid { border-color: #ef4444 !important; }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-md mx-auto bg-white min-h-screen shadow-xl relative overflow-hidden">
        <div class="page-content">
            <!-- ... (All your HTML content as before, unchanged, for brevity. Paste your body markup here) ... -->
            <!-- For space, see the original you posted. The key is the <script> below! -->
        </div>
        <!-- ... (Footer and Settings page as before) ... -->
    </div>
    <!-- Settings page ... -->

    <!-- Main App Script -->
    <script>
        // --- DARK MODE (persisted) ---
        function updateDarkModeUI(isDark) {
            document.body.classList.toggle('dark', isDark);
            // Update toggle in settings if present
            let dmSwitch = document.getElementById('darkModeSwitch');
            if (dmSwitch) dmSwitch.checked = isDark;
        }
        function getDarkPref() { return localStorage.getItem('darkMode') === 'true'; }
        function setDarkPref(val) { localStorage.setItem('darkMode', val ? 'true' : 'false'); }
        document.addEventListener('DOMContentLoaded', () => {
            updateDarkModeUI(getDarkPref());
            // Attach to dark mode toggle
            let dmSwitch = document.getElementById('darkModeSwitch');
            if (dmSwitch) dmSwitch.addEventListener('change', e => {
                setDarkPref(e.target.checked);
                updateDarkModeUI(e.target.checked);
            });
        });

        // --- NAVIGATION LOGIC ---
        const navButtons = document.querySelectorAll('footer .nav-feature-btn, .nav-feature-btn');
        const backButtons = document.querySelectorAll('.backBtn');
        const pages = ['dashboardPage', 'learningModulePage', 'trackingPage', 'rewardsPage', 'hypoGuidePage', 'learningPathPage', 'settingsPage'];
        function showPage(pageId) {
            pages.forEach(id => {
                const page = document.getElementById(id);
                if (page) { page.classList.add('hidden'); page.scrollTop = 0; }
            });
            const targetPage = document.getElementById(pageId);
            if (targetPage) { targetPage.classList.remove('hidden'); }
            document.querySelectorAll('footer .nav-feature-btn').forEach(btn => {
                if (btn.dataset.target === pageId) {
                    btn.classList.add('active-nav-btn', 'text-indigo-600');
                    btn.classList.remove('text-slate-500');
                } else {
                    btn.classList.remove('active-nav-btn', 'text-indigo-600');
                    btn.classList.add('text-slate-500');
                }
            });
        }
        navButtons.forEach(button => {
            button.addEventListener('click', () => showPage(button.dataset.target));
        });
        backButtons.forEach(button => {
            button.addEventListener('click', () => showPage('dashboardPage'));
        });

        // --- PATIENT NAME PERSISTENCE ---
        document.addEventListener('DOMContentLoaded', () => {
            const patientNameInput = document.getElementById('patientName');
            const welcomeMessageEl = document.getElementById('welcomeMessage');
            const savedName = localStorage.getItem('patientName');
            if (savedName) {
                patientNameInput.value = savedName;
                welcomeMessageEl.textContent = `Welcome, ${savedName}! Your companion for insulin therapy success.`;
            } else {
                welcomeMessageEl.textContent = 'Your companion for insulin therapy success.';
            }
            patientNameInput.addEventListener('input', (event) => {
                const name = event.target.value;
                localStorage.setItem('patientName', name);
                welcomeMessageEl.textContent = name
                    ? `Welcome, ${name}! Your companion for insulin therapy success.` 
                    : 'Your companion for insulin therapy success.';
            });
        });

        // --- LOGOUT CONFIRMATION ---
        document.addEventListener('DOMContentLoaded', () => {
            let logoutBtn = Array.from(document.querySelectorAll('.settings-option')).find(b => b.textContent.trim().toLowerCase() === 'logout');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    if (!confirm('Are you sure you want to logout?')) e.preventDefault();
                });
            }
        });

        // --- BLOOD SUGAR TRACKING (PERSISTENT) ---
        document.addEventListener('DOMContentLoaded', () => {
            // DOM elements
            const bsSlider = document.getElementById('bsSlider');
            const bsValueDisplay = document.getElementById('bsValueDisplay');
            const saveReadingBtn = document.getElementById('saveReadingBtn');
            const timeSlots = document.querySelectorAll('.time-slot');
            const weeklySugarChartCtx = document.getElementById('weeklySugarChart')?.getContext('2d');
            let selectedTimeSlot = null;

            // Select time slot, highlight
            timeSlots.forEach(slot => {
                slot.addEventListener('click', () => {
                    timeSlots.forEach(s => s.classList.remove('selected'));
                    slot.classList.add('selected');
                    selectedTimeSlot = slot.textContent;
                });
            });
            // Slider display
            bsSlider.addEventListener('input', () => { bsValueDisplay.textContent = `${bsSlider.value} mg/dL`; });

            // Save readings
            saveReadingBtn.addEventListener('click', () => {
                if (selectedTimeSlot && bsSlider.value) {
                    let readings = JSON.parse(localStorage.getItem('bsReadings') || '[]');
                    readings.push({
                        time: selectedTimeSlot,
                        value: parseInt(bsSlider.value),
                        date: new Date().toISOString()
                    });
                    localStorage.setItem('bsReadings', JSON.stringify(readings));
                    alert(`Blood Sugar Reading Saved:\nTime: ${selectedTimeSlot}\nValue: ${bsSlider.value} mg/dL`);
                    renderWeeklyChart();
                    // Reset
                    timeSlots.forEach(s => s.classList.remove('selected'));
                    selectedTimeSlot = null;
                    bsSlider.value = 100;
                    bsValueDisplay.textContent = '100 mg/dL';
                } else {
                    alert('Please select a time slot and a blood sugar value.');
                }
            });

            // Render chart from localStorage entries
            function renderWeeklyChart() {
                if (!weeklySugarChartCtx) return;
                let readings = JSON.parse(localStorage.getItem('bsReadings') || '[]');
                let weekDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                let dayValues = [[],[],[],[],[],[],[]];
                readings.forEach(r => {
                    let d = new Date(r.date);
                    let weekday = d.getDay();
                    // JS: Sunday=0... need Sunday=6
                    let idx = (weekday === 0) ? 6 : weekday-1;
                    dayValues[idx].push(r.value);
                });
                let avgPerDay = dayValues.map(arr =>
                    arr.length ? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) : null
                );
                let dataPoints = avgPerDay.map(x => x!==null?x:0);
                // Chart.js
                if (window.weeklySugarChartObj) window.weeklySugarChartObj.destroy();
                window.weeklySugarChartObj = new Chart(weeklySugarChartCtx, {
                    type: 'line',
                    data: {
                        labels: weekDays,
                        datasets: [{
                            label: 'Blood Sugar (mg/dL)',
                            data: dataPoints,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79,70,229,0.2)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 5,
                            pointBackgroundColor: '#4f46e5',
                            pointBorderColor: '#fff',
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: false, title: {display:true, text:'Blood Sugar (mg/dL)'}, grid: {color:'#e2e8f0'}, ticks:{color:'#475569'} },
                            x: { grid:{display:false}, ticks:{color:'#475569'} }
                        }
                    }
                });
                // Time in range and stats
                let all = readings.map(r=>r.value);
                let inRange = all.filter(x=>x>=70 && x<=180).length;
                document.getElementById('tirPercentage').textContent = all.length ? Math.round(inRange/all.length*100)+'%' : '--%';
                document.getElementById('avgSugar').textContent = all.length ? Math.round(all.reduce((a,b)=>a+b,0)/all.length)+' mg/dL' : '---';
                document.getElementById('lowestSugar').textContent = all.length ? Math.min(...all)+' mg/dL' : '---';
                document.getElementById('highestSugar').textContent = all.length ? Math.max(...all)+' mg/dL' : '---';
                let mean = all.length?all.reduce((a,b)=>a+b,0)/all.length:0;
                let sd = all.length?Math.sqrt(all.reduce((a,b)=>a+(b-mean)**2,0)/all.length):0;
                document.getElementById('glucoseVariability').textContent = mean?Math.round(100*sd/mean)+'%' : '--%';
            }
            renderWeeklyChart();
        });

        // --- TOOLTIP for icons ---
        document.querySelectorAll('img[title]').forEach(img => {
            img.addEventListener('mouseenter', function() {
                let tooltip = document.createElement('div');
                tooltip.className = 'tooltip fixed z-50 px-2 py-1 text-xs bg-black text-white rounded';
                tooltip.textContent = img.title;
                document.body.appendChild(tooltip);
                let rect = img.getBoundingClientRect();
                tooltip.style.left = (rect.left + rect.width/2 - tooltip.offsetWidth/2) + 'px';
                tooltip.style.top = (window.scrollY + rect.top - tooltip.offsetHeight - 8) + 'px';
                img._tooltip = tooltip;
            });
            img.addEventListener('mouseleave', function() {
                if (img._tooltip) { img._tooltip.remove(); img._tooltip = null; }
            });
        });

        // --- PWA Service Worker (OPTIONAL, safe to remove if not using manifest/service worker) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js');
            });
        }
    </script>
</body>
</html>
